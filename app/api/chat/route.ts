import { NextRequest } from "next/server";
import OpenAI from "openai";

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ============================================
// ğŸ¯ íƒ­ ì •ë³´ (OpenAIê°€ íƒ­ ì´ë™ íŒë‹¨ìš©)
// ============================================
const TAB_INFO: Record<string, { name: string; keywords: string[] }> = {
  tab1: { name: "ì—°êµ¬ë¶„ì•¼", keywords: ["ì—°êµ¬", "ì—°êµ¬ë¶„ì•¼", "ë­˜ ì—°êµ¬", "ì–´ë–¤ ì—°êµ¬"] },
  tab2: { name: "í†µí•©êµìœ¡", keywords: ["í†µí•©", "í†µí•©êµìœ¡", "ì™œ í†µí•©", "êµìœ¡"] },
  tab3: { name: "ì·¨ì—…ì „ë§", keywords: ["ì·¨ì—…", "ì·¨ì—…ë¥ ", "ì·¨ì—…ì „ë§", "ì§„ë¡œ", "ì¼ìë¦¬"] },
  tab4: { name: "ì„¸ë¶€ì „ê³µ", keywords: ["ì„¸ë¶€", "ì„¸ë¶€ì „ê³µ", "ì „ê³µ", "ë¶„ì•¼"] },
  tab5: { name: "ë¯¸ë˜ê°€ì¹˜", keywords: ["ë¯¸ë˜", "ë¯¸ë˜ê°€ì¹˜", "AIì‹œëŒ€", "ì „ë§"] },
  tab6: { name: "íŒ€í”„ë¡œì íŠ¸", keywords: ["íŒ€í”Œ", "íŒ€í”„ë¡œì íŠ¸", "ë°œí‘œ", "ì¡°ë³„"] },
  tab7: { name: "ë°”ì´ì˜¤ìœµí•©", keywords: ["ë°”ì´ì˜¤", "ë°”ì´ì˜¤ìœµí•©", "í—¬ìŠ¤ì¼€ì–´", "ì˜ë£Œì‚°ì—…"] },
  tab8: { name: "ì°¨ëŒ€ë§Œì˜ê°•ì ", keywords: ["ì°¨ëŒ€", "ì°¨ì˜ê³¼í•™ëŒ€", "ê°•ì ", "íŠ¹ì§•", "ì¥ì "] },
  tab9: { name: "ì¡¸ì—…ìƒì§„ë¡œ", keywords: ["ì¡¸ì—…ìƒ", "ì¡¸ì—…", "ì„ ë°°", "ì–´ë””ì·¨ì—…"] },
  tab10: { name: "ì˜ˆìˆ ê²½ì˜", keywords: ["ì˜ˆìˆ ", "ì˜ˆìˆ ê²½ì˜", "ë¬¸í™”", "ì—”í„°", "ê³µì—°"] },
  tab11: { name: "ë””ì§€í„¸vs AI", keywords: ["ë””ì§€í„¸", "AI", "ë””ì§€í„¸ë³´ê±´", "AIì˜ë£Œ", "ì°¨ì´"] },
  tab12: { name: "ë¯¸ë””ì–´ìœµí•©", keywords: ["ë¯¸ë””ì–´", "ë¯¸ë””ì–´ìœµí•©", "ë°©ì†¡", "ì½˜í…ì¸ ", "ìœ íŠœë¸Œ"] },
  tab13: { name: "ìˆ˜í¬ìOK", keywords: ["ìˆ˜í•™", "ìˆ˜í¬ì", "ìˆ˜í•™ëª»í•´ë„", "ê³„ì‚°"] },
  tab14: { name: "ì˜ìƒê´‘ê³ ", keywords: ["ì˜ìƒ", "ì˜ìƒê´‘ê³ ", "ê´‘ê³ ", "í¬ë¦¬ì—ì´í„°"] },
};

const TAB_LIST_FOR_PROMPT = Object.entries(TAB_INFO)
  .map(([id, info]) => `${id}: ${info.name}`)
  .join(", ");

// ============================================
// ğŸ¯ íƒ­ë³„ ì„¤ëª… ìŠ¤í¬ë¦½íŠ¸ (REPEAT ëª¨ë“œìš©)
// ğŸ”§ 2026-01-12 ìˆ˜ì •: TTS ë°œìŒì„ ìœ„í•´ ë„ì–´ì“°ê¸°ì™€ ì‰¼í‘œë¡œ í˜¸í¡ ì¡°ì ˆ
// - "ê²½ì˜í•™ì „ê³µ" â†’ "ê²½ì˜í•™ ì „ê³µ"
// - ê¸´ ë¬¸ì¥ì— ì‰¼í‘œ ì¶”ê°€
// - ìˆ«ìëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ìœ ì§€ (í¼ì„¼íŠ¸ëŠ” TTSê°€ ì˜ ì½ìŒ)
// ============================================
const TAB_SCRIPTS: Record<string, string> = {
  tab1: `ì•ˆë…•í•˜ì„¸ìš”! ì—°êµ¬ ë¶„ì•¼ì— ëŒ€í•´ ì„¤ëª…ë“œë¦´ê²Œìš”. ìš°ë¦¬ ê²½ì˜í•™ ì „ê³µì€, ê²½ì˜ê¸°íš, ë§ˆì¼€íŒ…, íšŒê³„ì¬ë¬´, ì„¸ ê°€ì§€ í•µì‹¬ ë¶„ì•¼ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤. ê²½ì˜ê¸°íšì—ì„œëŠ” ESG í‰ê°€ì§€í‘œ ê°œë°œê³¼, ê¸°ì—…ì§€ë°°êµ¬ì¡°ë¥¼ ì—°êµ¬í•˜ê³ ìš”. ë§ˆì¼€íŒ…ì—ì„œëŠ” AI ì„œë¹„ìŠ¤ ë¡œë´‡ ìˆ˜ìš©ë„ì™€, MZì„¸ëŒ€ SNS ì „ëµì„ ì—°êµ¬í•©ë‹ˆë‹¤. íšŒê³„ì¬ë¬´ì—ì„œëŠ” ì œì•½ ë°”ì´ì˜¤ R&D íšŒê³„ì²˜ë¦¬ì™€, ê³µì‹œì •ë³´ ì‹ ë¢°ì„±ì„ ì—°êµ¬í•˜ê³  ìˆì–´ìš”.`,

  tab2: `í†µí•© êµìœ¡ì´ ì™œ ì¤‘ìš”í•œì§€ ì„¤ëª…ë“œë¦´ê²Œìš”. ê¸°ì—… ê²½ì˜ì€ í¼ì¦ê³¼ ê°™ì•„ì„œ, í•œ ì¡°ê°ë§Œìœ¼ë¡œëŠ” ì „ì²´ ê·¸ë¦¼ì„ ë³¼ ìˆ˜ ì—†ì–´ìš”. ì¬ë¬´ ì „ë¬¸ê°€ë„ ë§ˆì¼€íŒ… ROIë¥¼ ë¶„ì„í•´ì•¼ í•˜ê³ , íšŒê³„ì‚¬ë„ ì¸ê±´ë¹„ êµ¬ì¡°ë¥¼ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤. ì‹¤ì œ ê¸°ì—…ì—ì„œëŠ”, ì¬ë¬´íŒ€ê³¼ ë§ˆì¼€íŒ…íŒ€ì´ í•¨ê»˜ ì¼í•˜ê±°ë“ ìš”!`,

  tab3: `ì·¨ì—… ì „ë§ì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”. ìš°ë¦¬ ì „ê³µ ì·¨ì—…ë¥ ì€ 88.7%ë¡œ, ì „êµ­ í‰ê·  ëŒ€ë¹„ ìš°ìˆ˜í•©ë‹ˆë‹¤. ê²½ì˜ê¸°íš ì§ë¬´ê°€ 48.9%ë¡œ ê°€ì¥ ë§ê³ , íšŒê³„ ì„¸ë¬´ ê¸ˆìœµì´ 20.8%, ë§ˆì¼€íŒ…ì´ 14%ë¥¼ ì°¨ì§€í•´ìš”. ê²½ì˜í•™ ë‹¨ì¼ ì „ê³µë§Œìœ¼ë¡œë„, ì¶©ë¶„íˆ ë‹¤ì–‘í•œ ì‚°ì—…ì— ì§„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`,

  tab4: `ì„¸ë¶€ ì „ê³µì— ëŒ€í•´ ì„¤ëª…ë“œë¦´ê²Œìš”. ê²½ì˜ê¸°íšì€ ê¸°ì—… ì „ëµ ìˆ˜ë¦½ê³¼, ESG ê²½ì˜ì„ ë‹¤ë£¨ê³ ìš”. ë§ˆì¼€íŒ…ì€ ì†Œë¹„ì í–‰ë™ ë¶„ì„ê³¼, ë””ì§€í„¸ ë§ˆì¼€íŒ…ì„ ë°°ì›ë‹ˆë‹¤. íšŒê³„ì¬ë¬´ëŠ” ì¬ë¬´ì œí‘œ ë¶„ì„ê³¼, ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ë°°ì›Œìš”. íŠ¹íˆ ì°¨ì˜ê³¼í•™ëŒ€ë§Œì˜, í—¬ìŠ¤ì¼€ì–´ ë¹„ì¦ˆë‹ˆìŠ¤ì™€, ë¹„ì¦ˆë‹ˆìŠ¤ ì• ë„ë¦¬í‹±ìŠ¤, íŠ¹í™” ë¶„ì•¼ê°€ ìˆìŠµë‹ˆë‹¤!`,

  tab5: `ê²½ì˜í•™ì˜ ë¯¸ë˜ ê°€ì¹˜ì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”. AI ì‹œëŒ€ì—ë„, ê²½ì˜í•™ì€ ì˜¤íˆë ¤ ë” ì¤‘ìš”í•´ì§‘ë‹ˆë‹¤! AIì™€ ë¹…ë°ì´í„°ë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œ ì „í™˜í•˜ë ¤ë©´, ê²½ì˜ ì „ë¬¸ê°€ê°€ í•„ìš”í•˜ê±°ë“ ìš”. ì „ëµì  ì˜ì‚¬ê²°ì •, ì´í•´ê´€ê³„ì ì¡°ì •, ìœ¤ë¦¬ì  ê²½ì˜ íŒë‹¨ì€, AIê°€ ëŒ€ì²´í•  ìˆ˜ ì—†ëŠ” ì˜ì—­ì…ë‹ˆë‹¤.`,

  tab6: `íŒ€ í”„ë¡œì íŠ¸ì— ëŒ€í•´ ì„¤ëª…ë“œë¦´ê²Œìš”. ë„¤, ë§ì•„ìš”! ê²½ì˜í•™ê³¼ëŠ” íŒ€í”Œê³¼ ë°œí‘œê°€ ë§ìŠµë‹ˆë‹¤. ì‹¤ì œ ê¸°ì—…ì´ íŒ€ì›Œí¬ ê¸°ë°˜ì´ê¸° ë•Œë¬¸ì´ì—ìš”. íŒ€í”Œì„ í†µí•´, ì˜ì‚¬ì†Œí†µ ëŠ¥ë ¥, ë¬¸ì œí•´ê²° ëŠ¥ë ¥, ë¦¬ë”ì‹­ì„ ê¸°ë¥¼ ìˆ˜ ìˆê³ ìš”. ê¸°ì—…ê²½ì˜ì‚¬ë¡€ ê²½ì§„ëŒ€íšŒ ê°™ì€ ì‹¤ì „ ê²½í—˜ì€, ì·¨ì—… ì‹œ í° ê°•ì ì´ ë©ë‹ˆë‹¤!`,

  tab7: `ë°”ì´ì˜¤ ìœµí•©ì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”. ë°”ì´ì˜¤ì™€ ê²½ì˜ì˜ ì¡°í•©ì€ ì •ë§ ê°•ë ¥í•©ë‹ˆë‹¤! ë°”ì´ì˜¤ ì‚°ì—…ì€ R&D ë¹„ìš©ì´ ìˆ˜ì²œì–µ ì›ì— ë‹¬í•˜ê³ , ì œí’ˆ ì¶œì‹œê¹Œì§€ 10ë…„ ì´ìƒ ê±¸ë ¤ìš”. ê·¸ë˜ì„œ ì „ëµì  í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ì™€ íŒŒì´ë‚¸ì‹±ì´ í•„ìˆ˜ì…ë‹ˆë‹¤. ì‹¤ì œë¡œ ì¡¸ì—…ìƒì˜ 24.9%ê°€, ë°”ì´ì˜¤ í—¬ìŠ¤ì¼€ì–´ ë¶„ì•¼ë¡œ ì§„ì¶œí•˜ê³  ìˆì–´ìš”!`,

  tab8: `ì°¨ì˜ê³¼í•™ëŒ€ë§Œì˜ ê°•ì ì„ ì„¤ëª…ë“œë¦´ê²Œìš”. ìš°ë¦¬ëŠ” ë°”ì´ì˜¤ í—¬ìŠ¤ì¼€ì–´ íŠ¹í™” ê²½ì˜í•™ì…ë‹ˆë‹¤! ì°¨ë³‘ì› ë„¤íŠ¸ì›Œí¬ì™€ ì—°ê³„ë˜ì–´, ì¡¸ì—…ìƒì˜ 10.9%ê°€ ì°¨ë³‘ì›ê·¸ë£¹ì— ì·¨ì—…í•˜ê³ ìš”. ì˜ë£Œê²½ì˜, ë°”ì´ì˜¤ì‚°ì—…ë¡  ê°™ì€, íŠ¹í™” ì»¤ë¦¬í˜ëŸ¼ì´ ìˆì–´ìš”. í•œêµ­ì¡°ì„¸ì¬ì •ì—°êµ¬ì›, ê¸ˆìœµê°ë…ì› ë“±ê³¼ì˜ ì—°êµ¬ ë„¤íŠ¸ì›Œí¬ë„ ê°•ì ì…ë‹ˆë‹¤.`,

  tab9: `ì¡¸ì—…ìƒ ì§„ë¡œì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”. ì·¨ì—…ë¥  88.7%ì—, ì°½ì—… 5.4%, ëŒ€í•™ì› ì§„í•™ 5.9%ì…ë‹ˆë‹¤. ì‚°ì—…ë³„ë¡œëŠ”, ë°”ì´ì˜¤ í—¬ìŠ¤ì¼€ì–´ 24.9%, ê¸ˆìœµ 19.5%, IT 19%ì´ê³ ìš”. í•˜ë‚˜ì€í–‰, ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤, ì¿ íŒ¡, ì„¸ë¸Œë€ìŠ¤ë³‘ì› ë“±, ë‹¤ì–‘í•œ ë¶„ì•¼ì˜ ê¸°ì—…ì— ì·¨ì—…í•˜ê³  ìˆì–´ìš”!`,

  tab10: `ì˜ˆìˆ  ê²½ì˜ì— ëŒ€í•´ ì„¤ëª…ë“œë¦´ê²Œìš”. ì˜ˆìˆ ê³¼ ê²½ì˜ì€ ì™„ë²½í•œ ì¡°í•©ì…ë‹ˆë‹¤! ê³µì—°ê¸°íšì, ë¯¸ìˆ ê´€ íë ˆì´í„°, ë¬¸í™” ë§ˆì¼€í„°ë¡œ ì§„ì¶œí•  ìˆ˜ ìˆì–´ìš”. ì‹¤ì œë¡œ FNCì—”í„°í…Œì¸ë¨¼íŠ¸, ì„œìš¸í™˜ê²½ì˜í™”ì œ ë“±ì— ì·¨ì—…í•œ ì„ ë°°ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ì˜ˆìˆ ë„ ê´€ê°ì´ ìˆì–´ì•¼ í•˜ê³ , ìˆ˜ìµëª¨ë¸ ì„¤ê³„ê°€ í•„ìˆ˜ë‹ˆê¹Œìš”!`,

  tab11: `ë””ì§€í„¸ ë³´ê±´ì˜ë£Œì™€, AI ì˜ë£Œë°ì´í„°ì˜ ì°¨ì´ë¥¼ ì„¤ëª…ë“œë¦´ê²Œìš”. ë””ì§€í„¸ ë³´ê±´ì˜ë£ŒëŠ”, ì„œë¹„ìŠ¤ ê¸°íš ì¤‘ì‹¬ìœ¼ë¡œ ì‚¬ëŒê³¼ì˜ ì†Œí†µì´ ì¤‘ìš”í•˜ê³ , ë³‘ì› ê²½ì˜ê¸°íšì´ë‚˜, ë””ì§€í„¸ í—¬ìŠ¤ ì„œë¹„ìŠ¤ ê¸°íš ìª½ìœ¼ë¡œ ê°‘ë‹ˆë‹¤. AI ì˜ë£Œë°ì´í„°ëŠ”, ë°ì´í„° ë¶„ì„ ì¤‘ì‹¬ìœ¼ë¡œ, í—¬ìŠ¤ì¼€ì–´ ë°ì´í„° ë¶„ì„ê°€ë‚˜, ë³´í—˜ ë¦¬ìŠ¤í¬ ë¶„ì„ ìª½ìœ¼ë¡œ ì§„ì¶œí•´ìš”. ë‘˜ ë‹¤ ê²½ì˜í•™ê³¼ ì‹œë„ˆì§€ê°€ í½ë‹ˆë‹¤!`,

  tab12: `ë¯¸ë””ì–´ ìœµí•©ì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”. ë¯¸ë””ì–´ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ê³¼ ê²½ì˜í•™ì€ ì™„ë²½í•œ ì¡°í•©ì…ë‹ˆë‹¤! ìš”ì¦˜ ëª¨ë“  ê¸°ì—…ì´ ë¯¸ë””ì–´ ê¸°ì—…ì´ì—ìš”. ìœ íŠœë¸Œ, ì¸ìŠ¤íƒ€ ì±„ë„ì„ ì§ì ‘ ìš´ì˜í•˜ë‹ˆê¹Œìš”. IR, PR, ì½˜í…ì¸  ë¹„ì¦ˆë‹ˆìŠ¤, ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… ë¶„ì•¼ë¡œ ì§„ì¶œí•  ìˆ˜ ìˆê³ ìš”. ê´‘ê³ ëŒ€í–‰ì‚¬, ë°©ì†¡ì‚¬, MCN ê¸°ì—…ì— ì·¨ì—…í•œ ì„ ë°°ë“¤ì´ ë§ìŠµë‹ˆë‹¤!`,

  tab13: `ìˆ˜í•™ì´ ê±±ì •ë˜ì‹œëŠ” ë¶„ë“¤ê»˜ ë§ì”€ë“œë¦´ê²Œìš”. ê±±ì • ë§ˆì„¸ìš”! ê¸°ì´ˆë¶€í„° ì°¨ê·¼ì°¨ê·¼ ê°€ë¥´ì¹©ë‹ˆë‹¤. íšŒê³„ì›ë¦¬ëŠ”, ìì‚° = ë¶€ì±„ + ìë³¸, ì´ ê³µì‹ë¶€í„° ì‹œì‘í•˜ê³ ìš”. ê²½ì˜í†µê³„ëŠ” í‰ê· , ë¶„ì‚°ë¶€í„° ì‹œì‘í•´ìš”. ê³ ë“±í•™êµ ìˆ˜í•™ ìˆ˜ì¤€ì´ë©´ ì¶©ë¶„í•˜ê³ , êµìˆ˜í•™ìŠµì§€ì›ì„¼í„° íŠœí„°ë§ê³¼, ì„ ë°° ë©˜í† ë§ë„ ìˆìŠµë‹ˆë‹¤!`,

  tab14: `ì˜ìƒ ê´‘ê³ ì™€ ê²½ì˜ì˜ ì—°ê²°ì— ëŒ€í•´ ì„¤ëª…ë“œë¦´ê²Œìš”. ì˜ìƒ ì œì‘ ëŠ¥ë ¥ì— ê²½ì˜ ì „ëµì„ ë”í•˜ë©´, ìµœê°• ì½˜í…ì¸  í¬ë¦¬ì—ì´í„°ê°€ ë©ë‹ˆë‹¤! ë§ˆì¼€íŒ… í”„ë ˆì„ì›Œí¬ë¡œ ì˜ìƒì„ ê¸°íší•˜ê³ , A/B í…ŒìŠ¤íŠ¸ë¡œ ìµœì í™”í•˜ê³ , ROIë¥¼ ì¸¡ì •í•  ìˆ˜ ìˆì–´ìš”. ë‹¨ìˆœíˆ ì˜ˆìœ ì˜ìƒì´ ì•„ë‹ˆë¼, ëª©í‘œë¥¼ ë‹¬ì„±í•˜ëŠ” ì½˜í…ì¸ ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!`,
};

// ğŸ”§ 2026-01-12 ìˆ˜ì •: TTS ë°œìŒ ê·œì¹™ ì¶”ê°€
const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ ì°¨ì˜ê³¼í•™ëŒ€í•™êµ, ë¯¸ë˜ìœµí•©ëŒ€í•™, í—¬ìŠ¤ì¼€ì–´ìœµí•©í•™ë¶€, ê²½ì˜í•™ ì „ê³µì˜ AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.
í•™ìƒë“¤ì˜ ì „ê³µ ê´€ë ¨ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê³  ì •í™•í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.

## ğŸ”Š ë°œìŒ ê·œì¹™ (TTSìš© - ë§¤ìš° ì¤‘ìš”!)
- "ê²½ì˜í•™ì „ê³µ"ì€ í•­ìƒ "ê²½ì˜í•™ ì „ê³µ"ìœ¼ë¡œ ë„ì–´ì„œ ì‘ì„±
- "ì°¨ì˜ê³¼í•™ëŒ€í•™êµ"ëŠ” "ì°¨ì˜ê³¼í•™ëŒ€í•™êµ," ì²˜ëŸ¼ ì‰¼í‘œë¥¼ ë¶™ì—¬ì„œ í˜¸í¡ ëŠê¸°
- ê¸´ ë¬¸ì¥ì€ ì‰¼í‘œë¡œ ì ì ˆíˆ ë‚˜ëˆ„ê¸°
- ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬ë¡œ ì‘ì„±

## ì¤‘ìš”: ì‘ë‹µ í˜•ì‹
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "reply": "ì‚¬ìš©ìì—ê²Œ í•  ë§",
  "action": "none" ë˜ëŠ” "navigate",
  "tabId": null ë˜ëŠ” "tab1"~"tab14"
}

## íƒ­ ì´ë™ ê·œì¹™
ì‚¬ìš©ìê°€ íŠ¹ì • íƒ­ìœ¼ë¡œ ì´ë™ì„ ì›í•˜ë©´ (ì˜ˆ: "ì·¨ì—… ì •ë³´ ë³´ì—¬ì¤˜", "ë°”ì´ì˜¤ íƒ­ìœ¼ë¡œ ê°€ì¤˜", "ì˜ˆìˆ ê²½ì˜ ì•Œë ¤ì¤˜"):
- action: "navigate"
- tabId: í•´ë‹¹ íƒ­ ID
- reply: "ë„¤, [íƒ­ì´ë¦„] íƒ­ìœ¼ë¡œ ì´ë™í• ê²Œìš”!" í˜•íƒœë¡œ ì§§ê²Œ

ì‚¬ìš©ìê°€ ë‹¨ìˆœ ì§ˆë¬¸ë§Œ í•˜ë©´ (ì˜ˆ: "ì·¨ì—…ë¥ ì´ ì–´ë•Œ?", "ë­˜ ë°°ì›Œ?"):
- action: "none"
- tabId: null
- reply: ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ (2-3ë¬¸ì¥)

## íƒ­ ëª©ë¡
${TAB_LIST_FOR_PROMPT}

## íƒ­ ì´ë™ íŒë‹¨ í‚¤ì›Œë“œ
- "~íƒ­ìœ¼ë¡œ ê°€ì¤˜/ì´ë™í•´ì¤˜/ë³´ì—¬ì¤˜" â†’ navigate
- "~ì— ëŒ€í•´ ìì„¸íˆ/ë” ì•Œë ¤ì¤˜" â†’ navigate
- "~íƒ­ ì„¤ëª…í•´ì¤˜" â†’ navigate
- ë‹¨ìˆœ ì§ˆë¬¸ ("ì·¨ì—…ë¥ ì´ ì–´ë•Œ?", "ë­˜ ë°°ì›Œ?") â†’ none (ë‹µë³€ë§Œ)

## ê²½ì˜í•™ ì „ê³µ ì§€ì‹

### ì—°êµ¬ë¶„ì•¼
ê²½ì˜í•™ ì „ê³µì—ì„œëŠ” ê²½ì˜ê¸°íš, ë§ˆì¼€íŒ…, íšŒê³„ì¬ë¬´ì˜ í•µì‹¬ ì´ë¡ ì„ ë‹¤ë£¹ë‹ˆë‹¤.
- ê²½ì˜ê¸°íš: ê¸°ì—…ì „ëµ, ì¡°ì§ê´€ë¦¬, ESG í‰ê°€ì§€í‘œ ê°œë°œ, ê¸°ì—…ì§€ë°°êµ¬ì¡° ê°œì„ 
- ë§ˆì¼€íŒ…: ì†Œë¹„ì í–‰ë™, ë¸Œëœë“œ ì „ëµ, ì„œë¹„ìŠ¤ ë§ˆì¼€íŒ…, AI ì„œë¹„ìŠ¤ ë¡œë´‡ ìˆ˜ìš©ë„, MZì„¸ëŒ€ SNS ì „ëµ
- íšŒê³„ì¬ë¬´: ê¸°ì—…ê°€ì¹˜ í‰ê°€, íšŒê³„íˆ¬ëª…ì„±, íˆ¬ìì˜ì‚¬ê²°ì •, ì œì•½ ë°”ì´ì˜¤ R&D íšŒê³„ì²˜ë¦¬

### ì·¨ì—…ë¥  ë° ì§„ë¡œ
- ì·¨ì—…ë¥ : 88.7% (ì „êµ­ í‰ê·  ëŒ€ë¹„ ìš°ìˆ˜)
- ì§ë¬´ë³„: ê²½ì˜ê¸°íš 48.9%, íšŒê³„ ì„¸ë¬´ ê¸ˆìœµ 20.8%, ë§ˆì¼€íŒ… 14.0%
- ì‚°ì—…ë³„: ë°”ì´ì˜¤ í—¬ìŠ¤ì¼€ì–´ 24.9%, ê¸ˆìœµ 19.5%, IT 19.0%, ì°¨ë³‘ì›ê·¸ë£¹ 10.9%

### ì£¼ìš” ì·¨ì—…ì²˜
- ê¸ˆìœµ: í•˜ë‚˜ì€í–‰, SKì¦ê¶Œ, ì‹ í•œì€í–‰, KBêµ­ë¯¼ì€í–‰
- ëŒ€ê¸°ì—…: í˜„ëŒ€ìë™ì°¨, ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤, ë¡¯ë°, CJì˜¬ë¦¬ë¸Œì˜
- IT: ì¿ íŒ¡, ìŠ¤ë§ˆì¼ê²Œì´íŠ¸, ë©”ê°€ì¡´í´ë¼ìš°ë“œ
- ë³‘ì›: ì„¸ë¸Œë€ìŠ¤ë³‘ì›, ì°¨ë³‘ì› ê³„ì—´

### ì°¨ì˜ê³¼í•™ëŒ€ íŠ¹í™” ë¶„ì•¼
- í—¬ìŠ¤ì¼€ì–´ ë¹„ì¦ˆë‹ˆìŠ¤: ì˜ë£Œì„œë¹„ìŠ¤ ê²½ì˜, ì˜ë£Œê´€ê´‘, ë°”ì´ì˜¤ì‚°ì—… ë¶„ì„
- ë¹„ì¦ˆë‹ˆìŠ¤ ì• ë„ë¦¬í‹±ìŠ¤: ê²½ì˜ ë¹…ë°ì´í„° ë¶„ì„, ê±´ê°•ë³´í—˜ê³µë‹¨ ë°ì´í„° í™œìš©
- ì°¨ë³‘ì› ë„¤íŠ¸ì›Œí¬: ì¡¸ì—…ìƒ 10.9%ê°€ ì°¨ë³‘ì›ê·¸ë£¹ ì·¨ì—…
`;

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { type, tabId, message, history } = body;

    // ============================================
    // ğŸ¯ íƒ­ ì„¤ëª… ìš”ì²­ ì²˜ë¦¬ (OpenAI í˜¸ì¶œ ì—†ì´ ê³ ì • ìŠ¤í¬ë¦½íŠ¸ ë°˜í™˜)
    // ============================================
    if (type === "tab_explain") {
      const script = TAB_SCRIPTS[tabId];
      
      if (script) {
        console.log(`ğŸ“‘ Tab explain request: ${tabId}`);
        return new Response(JSON.stringify({ reply: script, action: "none", tabId: null }), {
          status: 200,
          headers: { "Content-Type": "application/json" },
        });
      } else {
        return new Response(JSON.stringify({ reply: "í•´ë‹¹ íƒ­ì— ëŒ€í•œ ì„¤ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", action: "none", tabId: null }), {
          status: 200,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // ============================================
    // ğŸ’¬ ì¼ë°˜ ì±„íŒ… ìš”ì²­ ì²˜ë¦¬ (OpenAI API ì‚¬ìš©)
    // ============================================
    if (!process.env.OPENAI_API_KEY) {
      throw new Error("OpenAI API key is missing");
    }

    const messages: OpenAI.ChatCompletionMessageParam[] = [
      { role: "system", content: SYSTEM_PROMPT },
      ...(history || []).map((msg: { role: string; content: string }) => ({
        role: msg.role as "user" | "assistant",
        content: msg.content,
      })),
      { role: "user", content: message },
    ];

    const response = await client.chat.completions.create({
      model: "gpt-4o-mini",
      messages,
      max_tokens: 300,
      temperature: 0,
      response_format: { type: "json_object" },
    });

    const rawReply = response.choices[0]?.message?.content || '{"reply": "ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "action": "none", "tabId": null}';
    
    // JSON íŒŒì‹±
    let parsedReply;
    try {
      parsedReply = JSON.parse(rawReply);
    } catch {
      console.error("JSON parse error, raw:", rawReply);
      parsedReply = { reply: rawReply, action: "none", tabId: null };
    }

    console.log("ğŸ¤– OpenAI response:", parsedReply);

    return new Response(JSON.stringify(parsedReply), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  } catch (error) {
    console.error("API error:", error);
    return new Response(JSON.stringify({ reply: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", action: "none", tabId: null }), {
      status: 500,
      headers: { "Content-Type": "application/json" },
    });
  }
}
